# **포트폴리오 업로드 기능: S3 권한 문제 해결 과정**

## 📚 목차

1. [초기 문제 상황: 403 Forbidden 에러 발생](#1_초기_문제_상황_403_Forbidden_에러_발생)
2. [원인 분석 및 해결 전략 선택](#2_원인_분석_및_해결_전략_선택)
3. [1차 해결 시도 (Pre-Signed URL 구현)](<#3_1차_해결_시도_(Pre-Signed_URL_구현)>)
4. [새로운 문제 발생: NoSuchKey 에러](#4_새로운_문제_발생_NoSuchKey_에러)
5. [NoSuchKey 최종 원인 분석 및 해결 (실제 코드 기반)](<#5_NoSuchKey_최종_원인_분석_및_해결_(실제_코드_기반)>)

---

## **1. 초기 문제 상황: `403 Forbidden` 에러 발생**

**구현 내용:**

- 사용자의 프로필(`Profile`)에는 포트폴리오 정보를 담는 `Portfolio` 객체가 필드로 존재한다.
- 사용자가 포트폴리오 파일(PDF, 이미지 등)을 업로드하면, 파일은 AWS S3 버킷에 저장된다.
- S3에 저장된 파일의 URL과 원본 파일 이름은 `Portfolio` 객체에 정상적으로 저장된다.

**문제점:**

- 데이터베이스에는 URL이 올바르게 저장되었으나, `ProfileResponse`를 통해 전달받은 이 URL을 웹 브라우저에서 직접 클릭하여 접근하면, 파일이 보이는 대신 **`403 Forbidden` (접근 거부)** 에러가 발생했다.

---

## **2. 원인 분석 및 해결 전략 선택**

**원인 진단:**

- S3 버킷과 그 안의 객체(파일)는 기본적으로 **비공개(Private)**로 설정된다. 따라서 외부에서 URL을 통해 직접 접근하려는 모든 시도는 보안 정책에 의해 차단된다. 이것이 `403 Forbidden` 에러의 직접적인 원인이다.

**해결 전략:**

- **'최소 권한 원칙'**에 따라, 보안성이 월등히 뛰어난 **'Pre-Signed URL 사용'** 방식을 채택하기로 결정했다. 이는 개인 정보가 포함될 수 있는 포트폴리오 파일을 안전하게 보호하기 위한 최선의 선택이다.

---

## **3. 1차 해결 시도 (Pre-Signed URL 구현)**

선택한 전략에 따라 아래와 같이 코드를 수정했다.

1. **`S3Service` 수정:** 파일 키(key)를 받아 Pre-Signed URL을 생성하는 `getPresignedUrl(String fileKey)` 메서드를 새로 추가했다.
2. **`ProfileResponse` 수정:** `Portfolio` 객체의 정보를 DTO로 변환할 때, DB에 저장된 원본 S3 URL을 그대로 반환하는 대신, `S3Service.getPresignedUrl()`을 호출하여 **매번 새로운 Pre-Signed URL을 생성**하여 반환하도록 로직을 변경했다.

---

## **4. 새로운 문제 발생: `NoSuchKey` 에러**

1차 해결책을 적용하고 다시 테스트한 결과, `403 Forbidden` 에러는 성공적으로 해결되었다. 하지만 이제 Pre-Signed URL을 클릭하면, 브라우저에 아래와 같은 새로운 에러가 XML 형태로 표시되었다.

```xml
<Error>
<Code>NoSuchKey</Code>
<Message>The specified key does not exist.</Message>
<Key>tmp.pdf</Key>
<RequestId>...</RequestId>
<HostId>...</HostId>
</Error>
```

**새로운 문제:** S3가 "요청한 URL은 유효하지만, 그 URL이 가리키는 파일(Key)이 버킷 안에 존재하지 않습니다" 라고 응답하고 있다.

---

## **5. `NoSuchKey` 최종 원인 분석 및 해결 (실제 코드 기반)**

이 문제의 진짜 원인을 파악하기 위해, `ProfileResponse` DTO가 생성되는 과정과 `S3Service`의 관련 메서드를 함께 분석했다.

### **원인 진단: "잘못된 재료로 파일 키 요청"**

`NoSuchKey` 에러의 근본적인 원인은, S3에 파일이 유니크한 이름으로 저장된다는 점을 간과하고, **원본 파일 이름**으로 Pre-Signed URL 생성을 시도했기 때문임이 밝혀졌다.

1. **S3 저장 방식:** `S3Service`의 `uploadFile` 메서드는 `createUniqueFileName`을 통해 S3에 파일을 저장할 때 **`portfolio/uuid-원본파일이름.pdf`** 와 같이 유니크한 이름으로 저장한다.
2. **DB 저장 정보:**
   - `portfolio.url`: 유니크한 이름이 포함된 **전체 URL**이 저장된다.
   - `portfolio.fileName`: **원본 파일 이름**이 저장된다.
3. **초기 구현 실수:** `getPresignedUrl` 메서드는 초기에 아래와 같이 파일 키(`fileName`)를 직접 받아 URL을 생성하도록 구현되었다.

   ```java
   // 초기 S3Service의 getPresignedUrl 메서드
   public String getPresignedUrl(String fileName) {
       // Presigned URL의 만료 시간 설정 (예: 1시간)
       Date expiration = new Date(System.currentTimeMillis() + 1000 * 60 * 60);

       // Presigned URL 생성
       GeneratePresignedUrlRequest generatePresignedUrlRequest =
               new GeneratePresignedUrlRequest(bucketName, fileName) // 파일 키를 직접 사용
                       .withExpiration(expiration);

       URL url = s3Client.generatePresignedUrl(generatePresignedUrlRequest);
       return url.toString();
   }
   ```

4. **문제 발생 코드:** `ProfileResponse` DTO를 생성하는 과정에서, 위 메서드에 **`portfolio.getFileName()`**, 즉 **'원본 파일 이름'**을 전달했다.

   ```java
   // 수정 전 ProfileResponse 생성 로직
   String presignedUrl = s3Service.getPresignedUrl(portfolio.getFileName()); // 잘못된 값을 전달!
   ```

5. **결과:** `S3Service`는 `portfolio/원본파일이름.pdf` 라는 키로 Pre-Signed URL 생성을 시도했고, S3에는 해당 키를 가진 파일이 존재하지 않았기 때문에 `NoSuchKey` 에러가 발생한 것이다.

### **최종 해결책: "올바른 재료로 파일 키 요청하기"**

이 문제를 해결하기 위해, `ProfileResponse` DTO 생성 로직에서 `getPresignedUrl` 메서드에 **'원본 파일 이름'** 대신, **'전체 URL'**을 전달하도록 수정했다. 동시에, `S3Service`의 `getPresignedUrl` 메서드도 전체 URL을 받아 내부에서 파일 키를 추출하도록 변경했다.

**✅ 최종 `ProfileResponse` 생성 로직:**

```java
// 수정 후 ProfileResponse 생성 로직

if (isMyProfile) {
    Portfolio portfolio = profile.getPortfolio();
    if (portfolio != null) {
        // [핵심 해결책 1]
        // S3Service가 전체 URL에서 올바른 파일 키를 추출할 수 있도록,
        // portfolio.getFileName() 대신 portfolio.getUrl()을 전달한다.
        String presignedUrl = s3Service.getPresignedUrl(portfolio.getUrl());
        builder.portfolio(new Portfolio(presignedUrl, portfolio.getFileName()));
    }
}
```

**✅ 최종 `S3Service`의 `getPresignedUrl` 메서드:**

```java
// S3Service.java

public String getPresignedUrl(String fileUrl) {
    // [핵심 해결책 2]
    // "https://.../portfolio/..." 형태의 전체 URL에서,
    // "portfolio/" 부터 시작하는 실제 파일 키(File Key)를 추출한다.
    String fileKey = fileUrl.substring(fileUrl.indexOf("portfolio/"));

    // 1시간 동안 유효한 만료 시간을 설정한다.
    Date expiration = new Date(System.currentTimeMillis() + 1000 * 60 * 60);

    // 추출된 fileKey를 사용하여 Pre-Signed URL 생성 요청을 만든다.
    GeneratePresignedUrlRequest generatePresignedUrlRequest =
            new GeneratePresignedUrlRequest(bucket, fileKey)
                    .withExpiration(expiration);

    URL url = amazonS3.generatePresignedUrl(generatePresignedUrlRequest);
    return url.toString();
}
```

이 수정을 통해, `S3Service`는 항상 올바른 전체 URL을 받아 정확한 파일 키를 추출할 수 있게 되었고, `NoSuchKey` 문제가 최종적으로 해결되었다.

---
